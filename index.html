<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Mini MAR</title>
<style>
  :root{
    --bg:#0b0b0f; --panel:#13131a; --panel2:#1b1b25;
    --text:#f2f2f7; --muted:#a1a1aa; --grid:#2a2a35;
    --accent:#0a84ff; --warn:#ff453a; --due:#ffd60a; --done:#34c759;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); height:100vh; overflow:hidden;}
  .app{display:flex; height:100vh; width:100vw;}
  .left{
    width:28%;
    min-width:170px;
    background:var(--panel);
    border-right:1px solid var(--grid);
    display:flex; flex-direction:column;
  }
  .right{flex:1; display:flex; flex-direction:column; overflow:hidden;}
  .bar{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 12px; border-bottom:1px solid var(--grid); background:rgba(19,19,26,.95);
    gap:10px;
  }
  .title{font-weight:700}
  .btn{
    background:var(--accent); color:white; border:none; border-radius:10px;
    padding:10px 12px; font-weight:600; cursor:pointer; white-space:nowrap;
  }
  .btn.secondary{background:var(--panel2); border:1px solid var(--grid); color:var(--text);}
  .list{padding:10px; overflow:auto; flex:1;}
  .item{
    width:100%; text-align:left; padding:12px; margin:8px 0;
    background:var(--panel2); border:1px solid var(--grid);
    color:var(--text); border-radius:12px; cursor:pointer;
  }
  .item.active{outline:2px solid rgba(10,132,255,.8);}
  .sub{color:var(--muted); font-size:12px; margin-top:4px;}
  .content{flex:1; overflow:auto; padding:12px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;}
  .pill{padding:6px 10px; border:1px solid var(--grid); border-radius:999px; background:var(--panel2); color:var(--muted); font-size:12px;}
  .gridwrap{background:var(--panel); border:1px solid var(--grid); border-radius:14px; overflow:auto;}
  .grid{
    display:grid;
    grid-template-columns: 220px repeat(24, 70px);
    min-width: calc(220px + 24 * 70px);
  }
  .cell{
    border-right:1px solid var(--grid);
    border-bottom:1px solid var(--grid);
    padding:8px;
    font-size:12px;
    min-height:52px;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted);
  }
  .head{position:sticky; top:0; background:rgba(19,19,26,.98); z-index:3; font-weight:700; color:var(--text);}
  .head.left{left:0; position:sticky; z-index:4;}
  .leftcol{
    position:sticky; left:0; z-index:2;
    background:rgba(19,19,26,.98);
    justify-content:flex-start; color:var(--text); font-weight:600;
  }
  .dose{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,214,10,.20);
    color:var(--text);
    display:flex;
    flex-direction:column;
    gap:4px;
    cursor:pointer;
    user-select:none;
  }
  .dose .small{font-size:11px; color:var(--muted);}
  .dose.done{background:rgba(52,199,89,.22); border-color:rgba(52,199,89,.35);}
  .dose.late{background:rgba(255,69,58,.22); border-color:rgba(255,69,58,.45);}
  .muted{color:var(--muted)}
  .empty{padding:16px; color:var(--muted)}
  dialog{
    border:none; border-radius:16px; padding:0; width:min(560px, 92vw);
    background:var(--panel); color:var(--text);
    box-shadow: 0 20px 60px rgba(0,0,0,.55);
  }
  .dlg-head{padding:14px 14px; border-bottom:1px solid var(--grid); font-weight:800;}
  .dlg-body{padding:14px; display:flex; flex-direction:column; gap:10px;}
  label{font-size:12px; color:var(--muted)}
  input, select{
    width:100%; padding:12px 12px; border-radius:12px;
    background:var(--panel2); border:1px solid var(--grid); color:var(--text);
    outline:none;
  }
  .dlg-actions{display:flex; gap:10px; justify-content:flex-end; padding:14px; border-top:1px solid var(--grid);}
  .warnbox{
    padding:12px; border-radius:12px; border:1px solid rgba(255,69,58,.45);
    background:rgba(255,69,58,.18); color:var(--text); font-weight:700;
  }
  .two-col{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .days{display:flex; gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--grid); border-radius:12px; background:var(--panel2);}
  .daychip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--grid); background:rgba(255,255,255,.04);
    font-size:12px; color:var(--text); cursor:pointer; user-select:none;
  }
  .daychip input{width:auto; margin:0;}
  .radioRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .radioRow label{color:var(--text); font-size:13px;}
  .radioRow input{width:auto;}
  .calendarBtn{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--grid);
    background:var(--panel2);
    color:var(--text);
    font-weight:600;
    cursor:pointer;
    display:flex; align-items:center; gap:8px;
  }
  .calendarBtn input[type="date"]{
    padding:0; border:none; background:transparent;
    color:var(--text); font-weight:700;
  }
  .calendarBtn input[type="date"]::-webkit-calendar-picker-indicator{
    filter: invert(1); opacity:.9; cursor:pointer;
  }

  /* Login overlay */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.65);
    display:flex; align-items:center; justify-content:center;
    padding:18px; z-index:9999;
  }
  .card{
    width:min(560px, 94vw);
    background:var(--panel);
    border:1px solid var(--grid);
    border-radius:18px;
    overflow:hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,.55);
  }
  .card-head{
    padding:14px; border-bottom:1px solid var(--grid);
    font-weight:900;
    display:flex; justify-content:space-between; align-items:center;
  }
  .card-body{padding:14px; display:flex; flex-direction:column; gap:10px;}
  .err{color:var(--warn); font-size:12px; white-space:pre-wrap;}
  .hint{color:var(--muted); font-size:12px; line-height:1.35;}
</style>
</head>

<body>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <div class="card">
    <div class="card-head">
      <div>Login</div>
      <div class="muted" id="fbStatus">Firebase: checkingâ€¦</div>
    </div>
    <div class="card-body">
      <div>
        <label>Facility Code</label>
        <input id="facilityInput" placeholder="e.g., AHLTC001" autocomplete="off" />
      </div>
      <div>
        <label>Nurse ID</label>
        <input id="nurseInput" placeholder="e.g., n123" autocomplete="username" />
      </div>
      <div>
        <label>Password</label>
        <input id="passInput" type="password" placeholder="Password" autocomplete="current-password" />
      </div>

      <div class="hint">
        ë¡œê·¸ì¸ ë°©ì‹: <b>Facility Code + Nurse ID</b>ë¥¼ ì´ìš©í•´ ë‚´ë¶€ì ìœ¼ë¡œ ì´ë©”ì¼ì„ ë§Œë“¤ì–´ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.<br/>
        ì´ë©”ì¼ = <b>NurseID@FacilityCode.local</b><br/>
        (ì˜ˆ: n123@AHLTC001.local)
      </div>

      <div class="err" id="loginErr"></div>

      <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:6px;">
        <button class="btn secondary" id="demoBtn">Demo (no login)</button>
        <button class="btn" id="loginBtn">Login</button>
      </div>
    </div>
  </div>
</div>

<div class="app" id="appRoot" style="display:none;">
  <div class="left">
    <div class="bar">
      <div class="title">Patients</div>
      <button class="btn" id="addPatientBtn">+</button>
    </div>
    <div class="list" id="patientList"></div>
  </div>

  <div class="right">
    <div class="bar">
      <div>
        <div class="title" id="rightTitle">Select patient</div>
        <div class="sub" id="rightSub"></div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn secondary" id="prevDayBtn">â—€ï¸ Day</button>
        <button class="btn secondary" id="nextDayBtn">Day â–¶ï¸</button>

        <div class="calendarBtn" title="Select date">
          ğŸ“… <input type="date" id="datePicker" />
        </div>

        <button class="btn" id="addMedBtn" disabled>+ Med</button>
        <button class="btn secondary" id="printBtn" disabled>Print</button>
        <button class="btn secondary" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="content">
      <div class="row">
        <span class="pill" id="todayPill"></span>
        <span class="pill" id="whoPill">Not signed in</span>
        <span class="pill">Tap dose = give / tap again = cancel</span>
        <span class="pill">Warn if outside Â±1h</span>
      </div>

      <div class="gridwrap" id="gridWrap">
        <div class="empty">Select a patient to view MAR.</div>
      </div>
    </div>
  </div>
</div>

<!-- Add Patient Dialog -->
<dialog id="patientDlg">
  <div class="dlg-head">Add Patient</div>
  <div class="dlg-body">
    <div>
      <label>Patient name</label>
      <input id="patientName" placeholder="e.g., Kim" />
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn secondary" id="patientCancel">Cancel</button>
    <button class="btn" id="patientSave">Save</button>
  </div>
</dialog>

<!-- Add Med Dialog -->
<dialog id="medDlg">
  <div class="dlg-head">Add Medication</div>
  <div class="dlg-body">
    <div>
      <label>Medication name</label>
      <input id="medName" placeholder="e.g., Metformin" />
    </div>

    <div>
      <label>Times (24h, comma-separated)</label>
      <input id="medTimes" placeholder="e.g., 09:00,13:00,21:00" />
    </div>

    <div class="muted" style="font-size:12px;">
      Tip: í•˜ë£¨ ì—¬ëŸ¬ ë²ˆì´ë©´ ì‹œê°„ì„ ì½¤ë§ˆë¡œ ì¶”ê°€í•˜ì„¸ìš”.
    </div>

    <div style="height:1px; background:var(--grid); margin:6px 0;"></div>

    <div>
      <label>Schedule ì˜µì…˜</label>
      <div class="radioRow">
        <label><input type="radio" name="schedType" value="weekly" checked /> ìš”ì¼(ì›”~ì¼)</label>
        <label><input type="radio" name="schedType" value="interval" /> _ì¼ì— í•œë²ˆ (ì‹œì‘ì¼ í¬í•¨)</label>
      </div>
    </div>

    <div id="weeklyBox">
      <label>ìš”ì¼ ì„ íƒ (ì›”~ì¼)</label>
      <div class="days" id="weekdayChips"></div>
      <div class="muted" style="font-size:12px;">
        ì²´í¬ëœ ìš”ì¼ì—ë§Œ í•´ë‹¹ ì•½ì´ MARì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
      </div>
    </div>

    <div id="intervalBox" style="display:none;">
      <div class="two-col">
        <div>
          <label>_ ì¼ì— í•œë²ˆ (2~6)</label>
          <input id="intervalN" inputmode="numeric" placeholder="2~6" />
        </div>
        <div>
          <label>ì‹œì‘ì¼</label>
          <input id="intervalStart" type="date" />
        </div>
      </div>
      <div class="muted" style="font-size:12px;">
        ì‹œì‘ì¼ì„ 1íšŒì°¨ë¡œ ë³´ê³ , Nì¼ ê°„ê²©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="dlg-actions">
    <button class="btn secondary" id="medCancel">Cancel</button>
    <button class="btn" id="medSave">Save</button>
  </div>
</dialog>

<!-- Warning Dialog -->
<dialog id="warnDlg">
  <div class="dlg-head">âš  íˆ¬ì—¬ì‹œê°„ ê²½ê³ </div>
  <div class="dlg-body">
    <div class="warnbox">íˆ¬ì—¬ì‹œê°„ ê²½ê³  - ì•½ì‚¬ì—ê²Œ ì—°ë½</div>
    <div class="muted" id="warnDetail" style="font-size:12px;"></div>
  </div>
  <div class="dlg-actions">
    <button class="btn" id="warnClose">Close</button>
  </div>
</dialog>

<!-- Initials Dialog -->
<dialog id="initialsDlg">
  <div class="dlg-head">Your Initials</div>
  <div class="dlg-body">
    <div class="muted" style="font-size:12px; line-height:1.35;">
      MAR ê¸°ë¡ì—ëŠ” <b>HH:MM + ì´ë‹ˆì…œ</b>ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.<br/>
      ì˜ˆ: <b>09:12 LSH</b> ë˜ëŠ” <b>09:12 LSH2</b>
    </div>
    <div>
      <label>Initials</label>
      <input id="initialsInput" placeholder="e.g., LSH or LSH2" maxlength="6" />
    </div>
    <div class="muted" style="font-size:12px;">
      * ê°™ì€ ì´ë‹ˆì…œì´ ìˆìœ¼ë©´ ìˆ«ìë¥¼ ë¶™ì—¬ì„œ êµ¬ë¶„í•˜ì„¸ìš”(ì˜ˆ: LSH2).
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn secondary" id="initialsLater">Later</button>
    <button class="btn" id="initialsSave">Save</button>
  </div>
</dialog>

<script type="module">
/* ===========================
   Firebase CDN + Auth (Firestore initë§Œ)
=========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAo6SXsvtUurqDJaH1EUxqMOqCvHV-GHDo",
  authDomain: "handle-5a293.firebaseapp.com",
  projectId: "handle-5a293",
  storageBucket: "handle-5a293.firebasestorage.app",
  messagingSenderId: "784177638758",
  appId: "1:784177638758:web:8f1c219333bcf23868aca7",
  measurementId: "G-9EY3N4JKCB"
};

let app = null, auth = null, db = null;
const fbStatus = document.getElementById("fbStatus");
const whoPill = document.getElementById("whoPill");

try{
  app = initializeApp(firebaseConfig);
  try{ getAnalytics(app); }catch(_e){}
  auth = getAuth(app);
  db = getFirestore(app);
  fbStatus.textContent = "Firebase: ready";
}catch(e){
  console.error("Firebase init error:", e);
  fbStatus.textContent = "Firebase: init error";
}

/* ===========================
   Small utilities
=========================== */
function pad2(n){ return String(n).padStart(2,'0'); }
function ymd(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
function parseISODate(s){
  var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s || "");
  if(!m) return null;
  return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 0,0,0,0);
}
function daysBetween(a,b){
  return Math.floor((a.getTime()-b.getTime())/(24*60*60*1000));
}
function parseTimesCSV(s){
  if(!s) return [];
  var parts = s.split(",").map(function(x){return x.trim();}).filter(Boolean);
  var ok = [];
  for(var i=0;i<parts.length;i++){
    var p = parts[i];
    if(/^\d{2}:\d{2}$/.test(p)){
      var hm = p.split(":");
      var h = Number(hm[0]), m = Number(hm[1]);
      if(h>=0 && h<=23 && m>=0 && m<=59) ok.push(p);
    }
  }
  ok.sort();
  // unique
  var out = [];
  for(i=0;i<ok.length;i++){
    if(i===0 || ok[i]!==ok[i-1]) out.push(ok[i]);
  }
  return out;
}
function dtForDay(dayDate, hhmm){
  var hm = hhmm.split(":");
  return new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), Number(hm[0]), Number(hm[1]), 0, 0);
}
function minutesDiff(a,b){
  return Math.abs((a.getTime()-b.getTime())/60000);
}
function escapeHtml(s){
  s = (s === null || s === undefined) ? "" : String(s);
  return s
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ===========================
   Login UI
=========================== */
const loginOverlay = document.getElementById("loginOverlay");
const appRoot = document.getElementById("appRoot");

const facilityInput = document.getElementById("facilityInput");
const nurseInput = document.getElementById("nurseInput");
const passInput = document.getElementById("passInput");
const loginBtn = document.getElementById("loginBtn");
const demoBtn = document.getElementById("demoBtn");
const loginErr = document.getElementById("loginErr");
const logoutBtn = document.getElementById("logoutBtn");

function makeEmail(facilityCode, nurseId){
  return (nurseId + "@" + facilityCode + ".local").toLowerCase();
}

let currentEmail = null;
let currentInitials = null;

function initialsKey(email){
  return "mini_mar_initials_" + String(email || "demo").toLowerCase();
}
function loadInitials(email){
  var v = localStorage.getItem(initialsKey(email));
  return (v && v.trim()) ? v.trim() : null;
}
function saveInitials(email, initials){
  localStorage.setItem(initialsKey(email), String(initials).trim().toUpperCase());
}
function setWhoPill(){
  var who = currentEmail ? ("Signed in: " + currentEmail) : "Demo mode (no sync)";
  var ini = currentInitials ? (" Â· Initials: " + currentInitials) : " Â· Initials: (unset)";
  whoPill.textContent = who + ini;
}

async function doLogin(){
  loginErr.textContent = "";
  var facilityCode = facilityInput.value.trim();
  var nurseId = nurseInput.value.trim();
  var password = passInput.value;

  if(!facilityCode || !nurseId || !password){
    loginErr.textContent = "Facility Code / Nurse ID / Passwordë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
    return;
  }
  var email = makeEmail(facilityCode, nurseId);
  try{
    await signInWithEmailAndPassword(auth, email, password);
  }catch(e){
    console.error(e);
    loginErr.textContent =
      "Login failed.\n" +
      "Email used: " + email + "\n" +
      "Error: " + (e && e.code ? e.code : "") + " " + (e && e.message ? e.message : "");
  }
}

loginBtn.onclick = doLogin;
passInput.addEventListener("keydown", function(ev){ if(ev.key==="Enter") doLogin(); });

demoBtn.onclick = function(){
  loginOverlay.style.display = "none";
  appRoot.style.display = "flex";
  currentEmail = null;
  currentInitials = loadInitials("demo") || "DM";
  setWhoPill();
  renderAll();
};

logoutBtn.onclick = async function(){
  try{ await signOut(auth); }catch(e){ console.error(e); }
};

onAuthStateChanged(auth, function(user){
  if(user){
    loginOverlay.style.display = "none";
    appRoot.style.display = "flex";
    currentEmail = user.email || "(unknown)";
    currentInitials = loadInitials(currentEmail);
    setWhoPill();
    if(!currentInitials) openInitialsDialog();
  }else{
    loginOverlay.style.display = "flex";
    appRoot.style.display = "none";
    currentEmail = null;
    currentInitials = null;
    setWhoPill();
  }
});

/* ===========================
   Mini MAR (Local storage)
=========================== */
const KEY = "mini_mar_v2_safe";
function loadState(){
  try{
    var raw = localStorage.getItem(KEY);
    if(!raw) return {patients:{}};
    var s = JSON.parse(raw);
    if(!s || !s.patients) return {patients:{}};
    return s;
  }catch(e){
    return {patients:{}};
  }
}
function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

const WEEKDAYS = [
  {k:1, label:"ì›”"},
  {k:2, label:"í™”"},
  {k:3, label:"ìˆ˜"},
  {k:4, label:"ëª©"},
  {k:5, label:"ê¸ˆ"},
  {k:6, label:"í† "},
  {k:0, label:"ì¼"},
];

function isMedActiveOnDate(medObj, date){
  var sch = medObj && medObj.schedule ? medObj.schedule : {type:"weekly", days:[0,1,2,3,4,5,6]};
  if(sch.type === "weekly"){
    var day = date.getDay();
    return Array.isArray(sch.days) && sch.days.indexOf(day) >= 0;
  }
  if(sch.type === "interval"){
    var every = Number(sch.every);
    var start = parseISODate(sch.start);
    if(!every || !start) return false;
    var d0 = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0,0,0,0);
    var diff = daysBetween(d0, start);
    if(diff < 0) return false;
    return (diff % every) === 0;
  }
  return true;
}

let state = loadState();
let selectedPatient = null;
let currentDay = new Date();
currentDay.setHours(0,0,0,0);

/* ===========================
   DOM refs
=========================== */
const patientListEl = document.getElementById("patientList");
const rightTitleEl = document.getElementById("rightTitle");
const rightSubEl = document.getElementById("rightSub");
const gridWrapEl = document.getElementById("gridWrap");
const todayPillEl = document.getElementById("todayPill");
const addMedBtn = document.getElementById("addMedBtn");
const printBtn = document.getElementById("printBtn");
const datePicker = document.getElementById("datePicker");

const patientDlg = document.getElementById("patientDlg");
const patientName = document.getElementById("patientName");
const patientSave = document.getElementById("patientSave");
const patientCancel = document.getElementById("patientCancel");

const medDlg = document.getElementById("medDlg");
const medName = document.getElementById("medName");
const medTimes = document.getElementById("medTimes");
const medSave = document.getElementById("medSave");
const medCancel = document.getElementById("medCancel");
const weeklyBox = document.getElementById("weeklyBox");
const intervalBox = document.getElementById("intervalBox");
const weekdayChips = document.getElementById("weekdayChips");
const intervalN = document.getElementById("intervalN");
const intervalStart = document.getElementById("intervalStart");

const warnDlg = document.getElementById("warnDlg");
const warnClose = document.getElementById("warnClose");
const warnDetail = document.getElementById("warnDetail");

const initialsDlg = document.getElementById("initialsDlg");
const initialsInput = document.getElementById("initialsInput");
const initialsSaveBtn = document.getElementById("initialsSave");
const initialsLaterBtn = document.getElementById("initialsLater");

function ensurePatient(name){
  if(!state.patients[name]) state.patients[name] = { meds:{} };
  if(!state.patients[name].meds) state.patients[name].meds = {};
  return state.patients[name];
}

/* ===========================
   Render
=========================== */
function renderPatients(){
  var names = Object.keys(state.patients).sort(function(a,b){ return a.localeCompare(b); });
  patientListEl.innerHTML = "";
  if(names.length===0){
    patientListEl.innerHTML = '<div class="empty">No patients. Tap +</div>';
    return;
  }
  for(var i=0;i<names.length;i++){
    (function(name){
      var btn = document.createElement("button");
      btn.className = "item" + (selectedPatient===name ? " active":"");
      var meds = Object.keys(state.patients[name].meds || {});
      btn.innerHTML = "<div>" + escapeHtml(name) + "</div><div class='sub'>" + meds.length + " meds</div>";
      btn.onclick = function(){ selectPatient(name); };
      patientListEl.appendChild(btn);
    })(names[i]);
  }
}

function renderHeader(){
  todayPillEl.textContent = "Day: " + ymd(currentDay);
  datePicker.value = ymd(currentDay);

  if(!selectedPatient){
    rightTitleEl.textContent = "Select patient";
    rightSubEl.textContent = "";
    addMedBtn.disabled = true;
    printBtn.disabled = true;
  }else{
    rightTitleEl.textContent = selectedPatient;
    var medsCount = Object.keys(state.patients[selectedPatient].meds||{}).length;
    rightSubEl.textContent = medsCount + " meds Â· Tap dose to record";
    addMedBtn.disabled = false;
    printBtn.disabled = false;
  }
  setWhoPill();
}

function renderGrid(){
  if(!selectedPatient){
    gridWrapEl.innerHTML = '<div class="empty">Select a patient to view MAR.</div>';
    return;
  }
  var patient = ensurePatient(selectedPatient);
  var meds = patient.meds || {};
  var medNames = Object.keys(meds).sort(function(a,b){return a.localeCompare(b);});

  var activeMeds = medNames.filter(function(m){ return isMedActiveOnDate(meds[m], currentDay); });

  if(activeMeds.length===0){
    gridWrapEl.innerHTML = '<div class="empty">No scheduled meds for this day. (Check schedule options)</div>';
    return;
  }

  var grid = document.createElement("div");
  grid.className = "grid";

  var h0 = document.createElement("div");
  h0.className = "cell head left";
  h0.textContent = "Medication";
  grid.appendChild(h0);

  for(var hr=0; hr<24; hr++){
    var hc = document.createElement("div");
    hc.className = "cell head";
    hc.textContent = pad2(hr)+":00";
    grid.appendChild(hc);
  }

  var dayKey = ymd(currentDay);

  for(var mi=0; mi<activeMeds.length; mi++){
    (function(med){
      var lc = document.createElement("div");
      lc.className = "cell leftcol";

      var sch = meds[med].schedule || {type:"weekly", days:[0,1,2,3,4,5,6]};
      var schText = "";
      if(sch.type === "weekly"){
        var labels = [];
        for(var wi=0;wi<WEEKDAYS.length;wi++){
          if(sch.days && sch.days.indexOf(WEEKDAYS[wi].k)>=0) labels.push(WEEKDAYS[wi].label);
        }
        schText = labels.length ? ("ìš”ì¼: " + labels.join("")) : "ìš”ì¼: (none)";
      }else{
        schText = String(sch.every) + "ì¼ë§ˆë‹¤ Â· ì‹œì‘ " + (sch.start || "-");
      }

      lc.innerHTML =
        "<div style='display:flex; flex-direction:column; gap:4px;'>" +
        "<div>" + escapeHtml(med) + "</div>" +
        "<div class='muted' style='font-size:11px;'>" + escapeHtml((meds[med].times||[]).join(", ")) + "</div>" +
        "<div class='muted' style='font-size:11px;'>" + escapeHtml(schText) + "</div>" +
        "</div>";

      grid.appendChild(lc);

      var hist = (meds[med].history && meds[med].history[dayKey]) ? meds[med].history[dayKey] : [];
      var bySched = {};
      for(var hi=0; hi<hist.length; hi++){
        if(hist[hi] && hist[hi].sched) bySched[hist[hi].sched] = hist[hi];
      }

      for(var hr2=0; hr2<24; hr2++){
        var c = document.createElement("div");
        c.className = "cell";
        c.style.justifyContent = "flex-start";
        c.style.alignItems = "flex-start";

        var times = (meds[med].times||[]).filter(function(t){ return Number(t.slice(0,2))===hr2; });

        if(times.length===0){
          c.textContent = "";
        }else{
          c.style.flexDirection = "column";
          c.style.gap = "6px";
          c.style.padding = "8px";
          c.style.color = "var(--text)";

          for(var ti=0; ti<times.length; ti++){
            (function(t){
              var rec = bySched[t];
              var block = document.createElement("div");
              block.className = "dose";
              if(rec && rec.status==="ok") block.classList.add("done");
              if(rec && rec.status==="late") block.classList.add("late");

              var givenText = rec ? ("Given: " + rec.given + " " + (rec.initials || "")).trim() : "Tap to Give";
              block.innerHTML = "<div><b>" + escapeHtml(t) + "</b></div><div class='small'>" + escapeHtml(givenText) + "</div>";
              block.onclick = function(){ toggleDose(med, t); };
              c.appendChild(block);
            })(times[ti]);
          }
        }
        grid.appendChild(c);
      }
    })(activeMeds[mi]);
  }

  gridWrapEl.innerHTML = "";
  gridWrapEl.appendChild(grid);
}

function renderAll(){
  renderPatients();
  renderHeader();
  renderGrid();
}

/* ===========================
   Actions
=========================== */
function selectPatient(name){
  selectedPatient = name;
  renderAll();
}

function addPatient(){
  patientName.value = "";
  patientDlg.showModal();
  patientName.focus();
}
function savePatientAction(){
  var name = patientName.value.trim();
  if(!name) return;
  ensurePatient(name);
  saveState();
  selectedPatient = name;
  patientDlg.close();
  renderAll();
}

function buildWeekdayChips(){
  weekdayChips.innerHTML = "";
  for(var i=0;i<WEEKDAYS.length;i++){
    var w = WEEKDAYS[i];
    var chip = document.createElement("label");
    chip.className = "daychip";
    chip.innerHTML = "<input type='checkbox' data-day='" + w.k + "' checked /> " + w.label;
    weekdayChips.appendChild(chip);
  }
}
function getSelectedSchedType(){
  var r = document.querySelector('input[name="schedType"]:checked');
  return r ? r.value : "weekly";
}
function updateScheduleUI(){
  var t = getSelectedSchedType();
  weeklyBox.style.display = (t==="weekly") ? "" : "none";
  intervalBox.style.display = (t==="interval") ? "" : "none";
}

function addMed(){
  if(!selectedPatient) return;
  medName.value = "";
  medTimes.value = "";
  intervalN.value = "";
  intervalStart.value = ymd(currentDay);

  buildWeekdayChips();
  document.querySelector('input[name="schedType"][value="weekly"]').checked = true;
  updateScheduleUI();

  medDlg.showModal();
  medName.focus();
}

function readWeeklyDays(){
  var checks = weekdayChips.querySelectorAll('input[type="checkbox"]');
  var out = [];
  for(var i=0;i<checks.length;i++){
    if(checks[i].checked) out.push(Number(checks[i].dataset.day));
  }
  return out;
}

function saveMedAction(){
  var m = medName.value.trim();
  var times = parseTimesCSV(medTimes.value.trim());
  if(!m || times.length===0) return;

  var p = ensurePatient(selectedPatient);
  p.meds = p.meds || {};
  if(!p.meds[m]) p.meds[m] = { times:[], history:{}, schedule:null };
  p.meds[m].times = times;
  p.meds[m].history = p.meds[m].history || {};

  var schedType = getSelectedSchedType();
  if(schedType === "weekly"){
    var days = readWeeklyDays();
    if(days.length === 0) return;
    p.meds[m].schedule = { type:"weekly", days: days };
  }else{
    var every = Number((intervalN.value||"").trim());
    var start = intervalStart.value;
    if(!(every>=2 && every<=6)) return;
    if(!start) return;
    p.meds[m].schedule = { type:"interval", every: every, start: start };
  }

  saveState();
  medDlg.close();
  renderAll();
}

function toggleDose(med, schedTime){
  var p = ensurePatient(selectedPatient);
  var md = p.meds[med];
  var dayKey = ymd(currentDay);
  md.history = md.history || {};
  md.history[dayKey] = md.history[dayKey] || [];
  var arr = md.history[dayKey];

  // If exists -> cancel
  var idx = -1;
  for(var i=0;i<arr.length;i++){
    if(arr[i] && arr[i].sched === schedTime){ idx = i; break; }
  }
  if(idx >= 0){
    arr.splice(idx, 1);
    saveState();
    renderAll();
    return;
  }

  // Need initials
  if(!currentInitials){
    openInitialsDialog();
    return;
  }

  // Add
  var now = new Date();
  var sched = dtForDay(currentDay, schedTime);
  var diff = minutesDiff(now, sched);
  var status = diff <= 60 ? "ok" : "late";

  var rec = {
    sched: schedTime,
    given: pad2(now.getHours()) + ":" + pad2(now.getMinutes()),
    status: status,
    initials: currentInitials
  };
  arr.push(rec);

  saveState();
  renderAll();

  if(status === "late"){
    warnDetail.textContent = "Scheduled " + schedTime + " Â· Given " + rec.given + " " + rec.initials + " Â· Diff " + Math.round(diff) + " min";
    warnDlg.showModal();
  }
}

function shiftDay(delta){
  currentDay = new Date(currentDay.getTime() + delta*24*60*60*1000);
  currentDay.setHours(0,0,0,0);
  renderAll();
}
function setDayFromPicker(){
  var d = parseISODate(datePicker.value);
  if(!d) return;
  currentDay = d;
  renderAll();
}

/* ===========================
   Initials
=========================== */
function openInitialsDialog(){
  initialsInput.value = currentInitials || "";
  initialsDlg.showModal();
  initialsInput.focus();
}
initialsSaveBtn.onclick = function(){
  var v = (initialsInput.value || "").trim().toUpperCase();
  if(!v) return;
  if(!/^[A-Z0-9]{2,6}$/.test(v)) return;
  var keyEmail = currentEmail || "demo";
  saveInitials(keyEmail, v);
  currentInitials = v;
  initialsDlg.close();
  setWhoPill();
  renderAll();
};
initialsLaterBtn.onclick = function(){
  initialsDlg.close();
  setWhoPill();
};

/* ===========================
   Print (Monthly)
   - IMPORTANT: no inline </script> anywhere inside JS strings.
=========================== */
function daysInMonth(date){
  return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
}
function fmtMonthTitle(date){
  return date.getFullYear() + "-" + pad2(date.getMonth()+1);
}

function buildMonthlyPrintHTML(patientName, monthDate){
  var patient = ensurePatient(patientName);
  var meds = patient.meds || {};
  var medNames = Object.keys(meds).sort(function(a,b){return a.localeCompare(b);});

  var y = monthDate.getFullYear();
  var m = monthDate.getMonth();
  var dim = daysInMonth(monthDate);

  // Rows: med x time
  var rows = [];
  for(var i=0;i<medNames.length;i++){
    var med = medNames[i];
    var times = meds[med].times || [];
    for(var j=0;j<times.length;j++){
      rows.push({med: med, time: times[j]});
    }
  }

  // Lookup
  var lookup = {}; // key day||med||time => {given, initials}
  for(var day=1; day<=dim; day++){
    var d = new Date(y, m, day, 0,0,0,0);
    var dayKey = ymd(d);
    for(i=0;i<medNames.length;i++){
      med = medNames[i];
      if(!isMedActiveOnDate(meds[med], d)) continue;
      var hist = (meds[med].history && meds[med].history[dayKey]) ? meds[med].history[dayKey] : [];
      var bySched = {};
      for(var hi=0; hi<hist.length; hi++){
        if(hist[hi] && hist[hi].sched) bySched[hist[hi].sched] = hist[hi];
      }
      times = meds[med].times || [];
      for(j=0;j<times.length;j++){
        var t = times[j];
        var rec = bySched[t];
        if(rec){
          lookup[day + "||" + med + "||" + t] = rec;
        }
      }
    }
  }

  var style =
    "<style>" +
    "@page{ size: landscape; margin: 10mm; }" +
    "body{ font-family: Arial, sans-serif; color:#000; }" +
    ".hdr{ display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #000; padding-bottom:6px; margin-bottom:8px; }" +
    ".hdr .t1{ font-weight:900; font-size:18px; }" +
    ".hdr .t2{ font-weight:700; font-size:12px; }" +
    ".meta{ display:flex; gap:18px; font-size:12px; margin:6px 0 10px; }" +
    "table{ border-collapse:collapse; width:100%; table-layout:fixed; }" +
    "th, td{ border:1px solid #000; font-size:10px; padding:2px; text-align:center; vertical-align:middle; }" +
    "th{ background:#f3f3f3; font-weight:800; }" +
    ".col-med{ width:230px; text-align:left; padding-left:6px; font-weight:800; }" +
    ".col-time{ width:60px; font-weight:800; }" +
    ".cell{ height:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }" +
    ".foot{ margin-top:10px; font-size:10px; display:flex; justify-content:space-between; }" +
    ".small{ font-size:10px; font-weight:700; }" +
    ".subtle{ color:#333; }" +
    "</style>";

  // Header row
  var thead = "<tr><th class='col-med'>MEDICATIONS</th><th class='col-time'>HOUR</th>";
  for(day=1; day<=dim; day++) thead += "<th>" + day + "</th>";
  thead += "</tr>";

  // Body
  var tbody = "";
  for(i=0;i<rows.length;i++){
    var r = rows[i];
    tbody += "<tr>";
    tbody += "<td class='col-med'>" + escapeHtml(r.med) + "</td>";
    tbody += "<td class='col-time'>" + escapeHtml(r.time) + "</td>";
    for(day=1; day<=dim; day++){
      var k = day + "||" + r.med + "||" + r.time;
      var rr = lookup[k];
      var txt = rr ? ((rr.given || "") + " " + (rr.initials || "")).trim() : "";
      tbody += "<td class='cell'>" + escapeHtml(txt) + "</td>";
    }
    tbody += "</tr>";
  }
  if(!tbody){
    tbody = "<tr><td colspan='" + (dim+2) + "' class='subtle'>No meds</td></tr>";
  }

  // Print trigger uses body onload (NO script tags)
  var facility = (facilityInput.value||"").trim() || "-";
  var html =
    "<!doctype html><html><head><meta charset='utf-8' />" +
    "<title>MAR Print</title>" + style + "</head>" +
    "<body onload='window.print()'>" +
    "<div class='hdr'><div class='t1'>MEDICATION ADMINISTRATION RECORD</div>" +
    "<div class='t2'>Month: " + escapeHtml(fmtMonthTitle(monthDate)) + "</div></div>" +
    "<div class='meta'>" +
    "<div><span class='small'>Patient:</span> " + escapeHtml(patientName) + "</div>" +
    "<div><span class='small'>Facility:</span> " + escapeHtml(facility) + "</div>" +
    "<div><span class='small'>Printed:</span> " + escapeHtml(new Date().toLocaleString()) + "</div>" +
    "</div>" +
    "<table><thead>" + thead + "</thead><tbody>" + tbody + "</tbody></table>" +
    "<div class='foot'><div class='subtle'>Cell content: HH:MM + initials</div><div class='subtle'>Mini MAR (local)</div></div>" +
    "</body></html>";

  return html;
}

function doPrint(){
  if(!selectedPatient) return;
  var w = window.open("", "_blank");
  if(!w) return;
  var html = buildMonthlyPrintHTML(selectedPatient, currentDay);
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ===========================
   Wiring
=========================== */
document.getElementById("addPatientBtn").onclick = addPatient;
patientSave.onclick = savePatientAction;
patientCancel.onclick = function(){ patientDlg.close(); };

addMedBtn.onclick = addMed;
medSave.onclick = saveMedAction;
medCancel.onclick = function(){ medDlg.close(); };

document.getElementById("prevDayBtn").onclick = function(){ shiftDay(-1); };
document.getElementById("nextDayBtn").onclick = function(){ shiftDay(1); };
datePicker.addEventListener("change", setDayFromPicker);

warnClose.onclick = function(){ warnDlg.close(); };
printBtn.onclick = doPrint;

var radios = document.querySelectorAll('input[name="schedType"]');
for(var i=0;i<radios.length;i++){
  radios[i].addEventListener("change", updateScheduleUI);
}

whoPill.style.cursor = "pointer";
whoPill.title = "Click to set initials";
whoPill.onclick = function(){ openInitialsDialog(); };

renderAll();
</script>

</body>
</html>
