<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Mini MAR</title>

  <style>
    :root{
      --bg:#0b0b0f; --panel:#13131a; --panel2:#1b1b25;
      --text:#f2f2f7; --muted:#a1a1aa; --grid:#2a2a35;
      --accent:#0a84ff; --warn:#ff453a;
      --due:#ffd60a; --done:#34c759;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); height:100vh; overflow:hidden;}
    .app{display:flex; height:100vh; width:100vw;}
    .left{width:28%; min-width:170px; background:var(--panel); border-right:1px solid var(--grid); display:flex; flex-direction:column;}
    .right{flex:1; display:flex; flex-direction:column; overflow:hidden;}
    .bar{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--grid); background:rgba(19,19,26,.95); gap:10px;}
    .title{font-weight:800}
    .btn{background:var(--accent); color:white; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; white-space:nowrap;}
    .btn.secondary{background:var(--panel2); border:1px solid var(--grid); color:var(--text);}
    .btn:disabled{opacity:.45; cursor:not-allowed;}
    .list{padding:10px; overflow:auto; flex:1;}
    .item{width:100%; text-align:left; padding:12px; margin:8px 0; background:var(--panel2); border:1px solid var(--grid); color:var(--text); border-radius:12px; cursor:pointer;}
    .item.active{outline:2px solid rgba(10,132,255,.8);}
    .sub{color:var(--muted); font-size:12px; margin-top:4px;}
    .content{flex:1; overflow:auto; padding:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;}
    .pill{padding:6px 10px; border:1px solid var(--grid); border-radius:999px; background:var(--panel2); color:var(--muted); font-size:12px;}
    .gridwrap{background:var(--panel); border:1px solid var(--grid); border-radius:14px; overflow:auto;}
    .grid{display:grid; grid-template-columns:220px repeat(24,70px); min-width:calc(220px + 24*70px);}
    .cell{border-right:1px solid var(--grid); border-bottom:1px solid var(--grid); padding:8px; font-size:12px; min-height:52px; display:flex; align-items:center; justify-content:center; color:var(--muted);}
    .head{position:sticky; top:0; background:rgba(19,19,26,.98); z-index:3; font-weight:800; color:var(--text);}
    .head.left{left:0; position:sticky; z-index:4;}
    .leftcol{position:sticky; left:0; z-index:2; background:rgba(19,19,26,.98); justify-content:flex-start; color:var(--text); font-weight:800;}
    .dose{width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,214,10,.20); color:var(--text); display:flex; flex-direction:column; gap:4px; cursor:pointer; user-select:none;}
    .dose .small{font-size:11px; color:var(--muted);}
    .dose.done{background:rgba(52,199,89,.22); border-color:rgba(52,199,89,.35);}
    .dose.late{background:rgba(255,69,58,.22); border-color:rgba(255,69,58,.45);}
    .empty{padding:16px; color:var(--muted)}
    dialog{border:none; border-radius:16px; padding:0; width:min(560px, 92vw); background:var(--panel); color:var(--text); box-shadow:0 20px 60px rgba(0,0,0,.55);}
    .dlg-head{padding:14px; border-bottom:1px solid var(--grid); font-weight:900;}
    .dlg-body{padding:14px; display:flex; flex-direction:column; gap:10px;}
    .dlg-actions{display:flex; gap:10px; justify-content:flex-end; padding:14px; border-top:1px solid var(--grid);}
    label{font-size:12px; color:var(--muted)}
    input, select{width:100%; padding:12px; border-radius:12px; background:var(--panel2); border:1px solid var(--grid); color:var(--text); outline:none;}
    .warnbox{padding:12px; border-radius:12px; border:1px solid rgba(255,69,58,.45); background:rgba(255,69,58,.18); color:var(--text); font-weight:900;}
    .hint{color:var(--muted); font-size:12px; line-height:1.35;}
    .err{color:var(--warn); font-size:12px; white-space:pre-wrap;}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; align-items:center; justify-content:center; padding:18px; z-index:9999;}
    .card{width:min(560px, 94vw); background:var(--panel); border:1px solid var(--grid); border-radius:18px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.55);}
    .card-head{padding:14px; border-bottom:1px solid var(--grid); font-weight:900; display:flex; justify-content:space-between; align-items:center;}
    .card-body{padding:14px; display:flex; flex-direction:column; gap:10px;}

    .calendarBtn{padding:10px 12px; border-radius:10px; border:1px solid var(--grid); background:var(--panel2); color:var(--text); font-weight:800; cursor:pointer; display:flex; align-items:center; gap:8px;}
    .calendarBtn input[type="date"]{padding:0; border:none; background:transparent; color:var(--text); font-weight:800;}
    .calendarBtn input[type="date"]::-webkit-calendar-picker-indicator{filter: invert(1); opacity:.9; cursor:pointer;}

    .radioRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .radioRow input{width:auto;}
    .days{display:flex; gap:8px; flex-wrap:wrap; padding:8px; border:1px solid var(--grid); border-radius:12px; background:var(--panel2);}
    .daychip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--grid); background:rgba(255,255,255,.04); font-size:12px; color:var(--text); cursor:pointer; user-select:none;}
    .daychip input{width:auto; margin:0;}

    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:10px;}

    @media (max-width: 860px){
      .left{width:38%}
      .grid{grid-template-columns:180px repeat(24,64px); min-width:calc(180px + 24*64px);}
    }
  </style>
</head>

<body>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <div class="card">
    <div class="card-head">
      <div>Login</div>
      <div class="muted" id="fbStatus">Firebase: checkingâ€¦</div>
    </div>
    <div class="card-body">
      <div>
        <label>Facility Code</label>
        <input id="facilityInput" placeholder="e.g., AHLTC001" autocomplete="off" />
      </div>
      <div>
        <label>Nurse ID</label>
        <input id="nurseInput" placeholder="e.g., n123" autocomplete="username" />
      </div>
      <div>
        <label>Password</label>
        <input id="passInput" type="password" placeholder="Password" autocomplete="current-password" />
      </div>

      <div class="hint">
        ë¡œê·¸ì¸ ë°©ì‹: <b>Facility Code + Nurse ID</b>ë¡œ ë‚´ë¶€ ì´ë©”ì¼ ìƒì„±<br/>
        ì´ë©”ì¼ = <b>NurseID@FacilityCode.local</b>
      </div>

      <div class="err" id="loginErr"></div>

      <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:6px;">
        <button class="btn secondary" id="demoBtn">Demo (no login)</button>
        <button class="btn" id="loginBtn">Login</button>
      </div>
    </div>
  </div>
</div>

<div class="app" id="appRoot" style="display:none;">
  <div class="left">
    <div class="bar">
      <div class="title">Patients</div>
      <button class="btn" id="addPatientBtn">+</button>
    </div>
    <div class="list" id="patientList"></div>
  </div>

  <div class="right">
    <div class="bar">
      <div>
        <div class="title" id="rightTitle">Select patient</div>
        <div class="sub" id="rightSub"></div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn secondary" id="prevDayBtn">â—€ï¸ Day</button>
        <button class="btn secondary" id="nextDayBtn">Day â–¶ï¸</button>

        <div class="calendarBtn" title="Select date">
          ğŸ“… <input type="date" id="datePicker" />
        </div>

        <button class="btn" id="addMedBtn" disabled>+ Med</button>
        <button class="btn secondary" id="printBtn" disabled>Print</button>
        <button class="btn secondary" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="content">
      <div class="row">
        <span class="pill" id="todayPill"></span>
        <span class="pill" id="whoPill">Not signed in</span>
        <span class="pill">Tap dose = give / tap again = cancel</span>
        <span class="pill">Warn if outside Â±1h</span>
      </div>

      <div class="gridwrap" id="gridWrap">
        <div class="empty">Select a patient to view MAR.</div>
      </div>
    </div>
  </div>
</div>

<!-- Add Patient Dialog -->
<dialog id="patientDlg">
  <div class="dlg-head">Add Patient</div>
  <div class="dlg-body">
    <div>
      <label>Patient name</label>
      <input id="patientName" placeholder="e.g., Kim" />
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn secondary" id="patientCancel">Cancel</button>
    <button class="btn" id="patientSave">Save</button>
  </div>
</dialog>

<!-- Add Med Dialog -->
<dialog id="medDlg">
  <div class="dlg-head">Add Medication</div>
  <div class="dlg-body">
    <div>
      <label>Medication name</label>
      <input id="medName" placeholder="e.g., Metformin" />
    </div>

    <div>
      <label>Times (24h, comma-separated)</label>
      <input id="medTimes" placeholder="e.g., 09:00,13:00,21:00" />
    </div>

    <div class="hint">Schedule ì˜µì…˜</div>
    <div class="radioRow">
      <label><input type="radio" name="schedType" value="weekly" checked /> ìš”ì¼(ì›”~ì¼)</label>
      <label><input type="radio" name="schedType" value="interval" /> _ì¼ì— í•œë²ˆ</label>
    </div>

    <div id="weeklyBox">
      <label>ìš”ì¼ ì„ íƒ (ì›”~ì¼)</label>
      <div class="days" id="weekdayChips"></div>
      <div class="hint">ì²´í¬ëœ ìš”ì¼ì—ë§Œ MARì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <div id="intervalBox" style="display:none;">
      <div class="two-col">
        <div>
          <label>_ ì¼ì— í•œë²ˆ (2~6)</label>
          <input id="intervalN" inputmode="numeric" placeholder="2~6" />
        </div>
        <div>
          <label>ì‹œì‘ì¼</label>
          <input id="intervalStart" type="date" />
        </div>
      </div>
      <div class="hint">ì‹œì‘ì¼ì„ 1íšŒì°¨ë¡œ ë³´ê³ , Nì¼ ê°„ê²©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <div class="dlg-actions">
    <button class="btn secondary" id="medCancel">Cancel</button>
    <button class="btn" id="medSave">Save</button>
  </div>
</dialog>

<!-- Warning Dialog -->
<dialog id="warnDlg">
  <div class="dlg-head">âš  íˆ¬ì—¬ì‹œê°„ ê²½ê³ </div>
  <div class="dlg-body">
    <div class="warnbox">íˆ¬ì—¬ì‹œê°„ ê²½ê³  - ì•½ì‚¬ì—ê²Œ ì—°ë½</div>
    <div class="muted" id="warnDetail" style="font-size:12px;"></div>
  </div>
  <div class="dlg-actions">
    <button class="btn" id="warnClose">Close</button>
  </div>
</dialog>

<!-- Initials Dialog -->
<dialog id="initialsDlg">
  <div class="dlg-head">Your Initials</div>
  <div class="dlg-body">
    <div class="hint">
      MAR ê¸°ë¡ì—ëŠ” <b>HH:MM + ì´ë‹ˆì…œ</b>ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤. (ì˜ˆ: 09:12 LSH)
    </div>
    <div>
      <label>Initials</label>
      <input id="initialsInput" placeholder="e.g., LSH or LSH2" maxlength="6" />
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn secondary" id="initialsLater">Later</button>
    <button class="btn" id="initialsSave">Save</button>
  </div>
</dialog>

<!-- IMPORTANT: external module -->
<script type="module" src="./sync.mjs"></script>
</body>
</html>
